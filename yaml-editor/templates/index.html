<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YAML Editor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .editor-container {
            margin-top: 20px;
        }
        #tree {
            width: 100%;
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 500px;
            overflow: auto;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
        .file-controls {
            margin-bottom: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .tree-controls {
            margin-bottom: 10px;
        }
        /* Fix for overlapping nodes */
        .jstree-default .jstree-node {
            margin-left: 24px;
        }
        .jstree-default .jstree-container-ul > .jstree-node {
            margin-left: 0;
        }
        .jstree-default .jstree-anchor {
            height: auto;
            white-space: normal;
            padding: 4px 8px;
        }
        /* Value display */
        .node-value {
            color: #666;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YAML Editor</h1>

        <!-- Combined File Controls -->
        <div class="file-controls">
            <input type="file" id="file-input" accept=".yml,.yaml">
            <select id="yaml-files" style="margin: 0 10px;">
                <option value="">Select existing file...</option>
                {% for file in yaml_files %}
                <option value="{{ file }}">{{ file }}</option>
                {% endfor %}
            </select>
            <button onclick="handleFile()">Load File</button>
        </div>

        <!-- Tree Controls -->
        <div class="tree-controls">
            <button onclick="$('#tree').jstree('open_all');">Expand All</button>
            <button onclick="$('#tree').jstree('close_all');">Collapse All</button>
            <button onclick="saveChanges()">Save Changes</button>
        </div>

        <!-- Tree Editor -->
        <div class="editor-container">
            <div id="tree"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script>
        let currentFileName = '';

        // Initialize jsTree
        $('#tree').jstree({
            'core': {
                'check_callback': true,
                'data': [],
                'themes': {
                    'responsive': false,
                    'variant': 'large'
                }
            },
            'plugins': ['contextmenu', 'wholerow', 'types'],
            'contextmenu': {
                'items': function(node) {
                    return {
                        'Add': {
                            'label': 'Add Child Node',
                            'action': function() {
                                addNode(node);
                            }
                        },
                        'Edit': {
                            'label': 'Edit Node',
                            'action': function() {
                                editNode(node);
                            }
                        },
                        'Delete': {
                            'label': 'Delete Node',
                            'action': function() {
                                deleteNode(node);
                            }
                        }
                    };
                }
            }
        });

        // Node operations
        function addNode(parentNode) {
            let name = prompt('Enter node name:');
            if (!name) return;

            let value = prompt('Enter value (leave empty for object):');
            let tree = $('#tree').jstree(true);

            let newNode = {
                text: value ? `${name}: ${value}` : name,
                data: { name: name, value: value }
            };

            let nodeId = tree.create_node(parentNode, newNode);
            tree.open_node(parentNode);
            tree.select_node(nodeId);
        }

        function editNode(node) {
            let tree = $('#tree').jstree(true);
            let currentName = node.data?.name || node.text.split(':')[0].trim();
            let currentValue = node.data?.value || '';

            let newName = prompt('Enter new name:', currentName);
            if (newName === null) return;

            let newValue = prompt('Enter new value:', currentValue);
            if (newValue === null) return;

            node.data = { name: newName, value: newValue };
            tree.rename_node(node, newValue ? `${newName}: ${newValue}` : newName);
        }

        function deleteNode(node) {
            if (confirm('Are you sure you want to delete this node?')) {
                $('#tree').jstree('delete_node', node);
            }
        }

        // Keyboard shortcuts
        $(document).on('keydown', function(e) {
            let tree = $('#tree').jstree(true);
            let selected = tree.get_selected();
            if (!selected.length) return;

            let node = tree.get_node(selected[0]);

            switch(e.keyCode) {
                case 46: // Delete
                    e.preventDefault();
                    deleteNode(node);
                    break;
                case 45: // Insert
                    e.preventDefault();
                    addNode(node);
                    break;
                case 113: // F2
                    e.preventDefault();
                    editNode(node);
                    break;
            }
        });

        function convertToJsTree(obj, parentId = '#') {
            let nodes = [];
            for (let key in obj) {
                let nodeId = Math.random().toString(36).substr(2, 9);
                let value = obj[key];
                let isObject = typeof value === 'object' && value !== null;

                let node = {
                    id: nodeId,
                    parent: parentId,
                    text: isObject ? key : `${key}: ${value}`,
                    data: {
                        name: key,
                        value: isObject ? null : value
                    }
                };
                nodes.push(node);

                if (isObject) {
                    nodes = nodes.concat(convertToJsTree(value, nodeId));
                }
            }
            return nodes;
        }

        function convertFromJsTree() {
            let result = {};
            let tree = $('#tree').jstree(true);
            let rootNodes = tree.get_node('#').children;

            function processNode(nodeId) {
                let node = tree.get_node(nodeId);
                let children = node.children;

                if (children.length === 0) {
                    return node.data?.value || '';
                }

                let nodeData = {};
                children.forEach(childId => {
                    let childNode = tree.get_node(childId);
                    nodeData[childNode.data.name] = processNode(childId);
                });
                return nodeData;
            }

            rootNodes.forEach(nodeId => {
                let node = tree.get_node(nodeId);
                result[node.data.name] = processNode(nodeId);
            });

            return result;
        }

        // Combined file handling
        async function handleFile() {
            const fileInput = document.getElementById('file-input');
            const fileSelect = document.getElementById('yaml-files');

            // Handle new file upload
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        currentFileName = data.filename;
                        await loadYamlContent(currentFileName);
                    } else {
                        alert('Upload failed: ' + data.error);
                    }
                } catch (error) {
                    alert('Upload failed: ' + error);
                }
            }
            // Handle existing file selection
            else if (fileSelect.value) {
                currentFileName = fileSelect.value;
                await loadYamlContent(currentFileName);
            } else {
                alert('Please select a file or upload a new one');
            }
        }

        async function loadYamlContent(filename) {
            try {
                const response = await fetch(`/load/${filename}`);
                const data = await response.json();

                if (data.error) {
                    alert('Error loading file: ' + data.error);
                    return;
                }

                const treeData = convertToJsTree(data);
                $('#tree').jstree(true).settings.core.data = treeData;
                $('#tree').jstree(true).refresh();
            } catch (error) {
                alert('Error loading file: ' + error);
            }
        }

        async function saveChanges() {
            if (!currentFileName) {
                alert('No file loaded');
                return;
            }

            const data = {
                filename: currentFileName,
                content: convertFromJsTree()
            };

            try {
                const response = await fetch('/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Changes saved successfully');
                } else {
                    alert('Error saving changes: ' + result.error);
                }
            } catch (error) {
                alert('Error saving changes: ' + error);
            }
        }
    </script>
</body>
</html>